<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Embedded GarageBand: mmc2.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Picture1.jpg"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Embedded GarageBand&#160;<span id="projectnumber">1.0</span></div>
   <div id="projectbrief">The project is aimed at developing an embedded Garage band that uses an 8051 microcontroller. The user can access the instruments via the touchscreen+graphics LCD or use the instruments that we have constructed. In this document we will cover the complete detail of the project including its construction, hardware design, software design and debugging.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('mmc2_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">mmc2.c File Reference</div>  </div>
</div>
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="mmc2_8h_source.html">mmc2.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="hal___s_p_i_8h_source.html">hal_SPI.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="hal__board_8h_source.html">hal_board.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="hal__cc8051_8h_source.html">hal_cc8051.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="hal__mcu_8h_source.html">hal_mcu.h</a>&quot;</code><br/>
</div>
<p><a href="mmc2_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">unsigned char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mmc2_8c.html#a1b26e131140b8ab739faa4dd100d6cf2">SD_init</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">unsigned char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mmc2_8c.html#a9faa6fa4ebcf98a07808f2d2c040dcfd">SD_sendCommand</a> (unsigned char cmd, unsigned long arg)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">unsigned char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mmc2_8c.html#a42f0a626164a7e52e260d0cd735e5479">SD_erase</a> (unsigned long <a class="el" href="mmc2_8h.html#aef9ccbd37ff89101204c1ab239f94453">startBlock</a>, unsigned long <a class="el" href="mmc2_8h.html#a18e6ba0217759ba11da835a1aa52edbf">totalBlocks</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">unsigned char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mmc2_8c.html#a479d5a79e118601ffede156b20d87494">SD_readSingleBlock</a> (unsigned long <a class="el" href="mmc2_8h.html#aef9ccbd37ff89101204c1ab239f94453">startBlock</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">unsigned char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mmc2_8c.html#aa72e78c5d2b4664dfdbb339030a1798c">SD_writeSingleBlock</a> (unsigned long <a class="el" href="mmc2_8h.html#aef9ccbd37ff89101204c1ab239f94453">startBlock</a>)</td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a42f0a626164a7e52e260d0cd735e5479"></a><!-- doxytag: member="mmc2.c::SD_erase" ref="a42f0a626164a7e52e260d0cd735e5479" args="(unsigned long startBlock, unsigned long totalBlocks)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned char SD_erase </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>startBlock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>totalBlocks</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="mmc2_8c_source.html#l00195">195</a> of file <a class="el" href="mmc2_8c_source.html">mmc2.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> response;
  
  response = <a class="code" href="mmc2_8c.html#a9faa6fa4ebcf98a07808f2d2c040dcfd">SD_sendCommand</a>(<a class="code" href="mmc2_8h.html#a0fe84e05b768d0f4b0f98a7f48a19f7f">ERASE_BLOCK_START_ADDR</a>, <a class="code" href="mmc2_8h.html#aef9ccbd37ff89101204c1ab239f94453">startBlock</a>); <span class="comment">//send starting block address</span>
  <span class="keywordflow">if</span>(response != 0x00) <span class="comment">//check for SD status: 0x00 - OK (No flags set)</span>
    <span class="keywordflow">return</span> response;
  
  response = <a class="code" href="mmc2_8c.html#a9faa6fa4ebcf98a07808f2d2c040dcfd">SD_sendCommand</a>(<a class="code" href="mmc2_8h.html#ade170f78d275c9bfd354e726e12435e2">ERASE_BLOCK_END_ADDR</a>,(<a class="code" href="mmc2_8h.html#aef9ccbd37ff89101204c1ab239f94453">startBlock</a> + <a class="code" href="mmc2_8h.html#a18e6ba0217759ba11da835a1aa52edbf">totalBlocks</a> - 1)); <span class="comment">//send end block address</span>
  <span class="keywordflow">if</span>(response != 0x00)
    <span class="keywordflow">return</span> response;
  
  response = <a class="code" href="mmc2_8c.html#a9faa6fa4ebcf98a07808f2d2c040dcfd">SD_sendCommand</a>(<a class="code" href="mmc2_8h.html#ae9177be3107326be877417b3b02e3a83">ERASE_SELECTED_BLOCKS</a>, 0); <span class="comment">//erase all selected blocks</span>
  <span class="keywordflow">if</span>(response != 0x00)
    <span class="keywordflow">return</span> response;
  
  <span class="keywordflow">return</span> 0; <span class="comment">//normal return</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a1b26e131140b8ab739faa4dd100d6cf2"></a><!-- doxytag: member="mmc2.c::SD_init" ref="a1b26e131140b8ab739faa4dd100d6cf2" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned char SD_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="mmc2_8c_source.html#l00037">37</a> of file <a class="el" href="mmc2_8c_source.html">mmc2.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i, response, SD_version;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> retry=0 ;
  
    <span class="comment">// Chip Select</span>
  <a class="code" href="hal__cc8051_8h.html#a116af97d27ecf005977027d74b2b1e21">MCU_IO_OUTPUT</a>(<a class="code" href="hal__board_8h.html#a1a68a64c8196904d31d5c04b969704ed">MMC_CS_PORT</a>,<a class="code" href="hal__board_8h.html#aaeb7204afc7f4f6d59ee5751e3ed909e">MMC_CS_PIN</a>,1);  <span class="comment">//MMC_CS_PxDIR |= MMC_CS;</span>
  
  <span class="comment">// Init SPI Module</span>
  <a class="code" href="hal___s_p_i_8c.html#afbecb4c823529eb4fee58ba57a918d44">halSPISetup</a>();
  
  <span class="keywordflow">for</span>(i=0;i&lt;10;i++)
    <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xff);   <span class="comment">//80 clock pulses spent before sending the first command</span>
  
  <a class="code" href="mmc2_8h.html#ab42aba8ac59f4a88718f351bf6e30874">SD_CS_ASSERT</a>;
  <span class="keywordflow">do</span>
  {
    
    response = <a class="code" href="mmc2_8c.html#a9faa6fa4ebcf98a07808f2d2c040dcfd">SD_sendCommand</a>(<a class="code" href="mmc2_8h.html#a939c1c73db7a96767f5d06dfe7591b01">GO_IDLE_STATE</a>, 0); <span class="comment">//send &#39;reset &amp; go idle&#39; command</span>
    retry++;
    <span class="keywordflow">if</span>(retry&gt;0x20) 
      <span class="keywordflow">return</span> 1;   <span class="comment">//time out, card not detected</span>
    
  } <span class="keywordflow">while</span>(response != 0x01);
  
  <a class="code" href="mmc2_8h.html#ac13a5b7ed7d2ee96da07f2b2ae9249fe">SD_CS_DEASSERT</a>;
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a> (0xff);
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a> (0xff);
  
  retry = 0;
  
  SD_version = 2; <span class="comment">//default set to SD compliance with ver2.x; </span>
  <span class="comment">//this may change after checking the next command</span>
  <span class="keywordflow">do</span>
  {
    response = <a class="code" href="mmc2_8c.html#a9faa6fa4ebcf98a07808f2d2c040dcfd">SD_sendCommand</a>(<a class="code" href="mmc2_8h.html#a01bcf82717d75d8ccf0a8664d431738d">SEND_IF_COND</a>,0x000001AA); <span class="comment">//Check power supply status, mendatory for SDHC card</span>
    retry++;
    <span class="keywordflow">if</span>(retry&gt;0xfe) 
    {
      <span class="comment">//TX_NEWLINE;</span>
      SD_version = 1;
      <a class="code" href="mmc2_8h.html#add9f7153567b2f38191b157d2caf7b79">cardType</a> = 1;
      <span class="keywordflow">break</span>;
    } <span class="comment">//time out</span>
    
  }<span class="keywordflow">while</span>(response != 0x01);
  
  retry = 0;
  
  <span class="keywordflow">do</span>
  {
    response = <a class="code" href="mmc2_8c.html#a9faa6fa4ebcf98a07808f2d2c040dcfd">SD_sendCommand</a>(<a class="code" href="mmc2_8h.html#acdb057504ceebb40cb4a5df3197a8fb5">APP_CMD</a>,0); <span class="comment">//CMD55, must be sent before sending any ACMD command</span>
    response = <a class="code" href="mmc2_8c.html#a9faa6fa4ebcf98a07808f2d2c040dcfd">SD_sendCommand</a>(<a class="code" href="mmc2_8h.html#a38e73c548131f1fd3f8acdad82fd44fb">SD_SEND_OP_COND</a>,0x40000000); <span class="comment">//ACMD41</span>
    
    retry++;
    <span class="keywordflow">if</span>(retry&gt;0xfe) 
    {
      <span class="comment">//TX_NEWLINE;</span>
      <span class="keywordflow">return</span> 2;  <span class="comment">//time out, card initialization failed</span>
    } 
    
  }<span class="keywordflow">while</span>(response != 0x00);
  
  
  retry = 0;
  <a class="code" href="mmc2_8h.html#a7fa85cbe61c04a9f71c57aaf1c04cfcc">SDHC_flag</a> = 0;
  
  <span class="keywordflow">if</span> (SD_version == 2)
  { 
    <span class="keywordflow">do</span>
    {
      response = <a class="code" href="mmc2_8c.html#a9faa6fa4ebcf98a07808f2d2c040dcfd">SD_sendCommand</a>(<a class="code" href="mmc2_8h.html#a9903337fbf33e03e1a9182fbca009313">READ_OCR</a>,0);
      retry++;
      <span class="keywordflow">if</span>(retry&gt;0xfe) 
      {
        <span class="comment">//TX_NEWLINE;</span>
        <a class="code" href="mmc2_8h.html#add9f7153567b2f38191b157d2caf7b79">cardType</a> = 0;
        <span class="keywordflow">break</span>;
      } <span class="comment">//time out</span>
      
    }<span class="keywordflow">while</span>(response != 0x00);
    
    <span class="keywordflow">if</span>(<a class="code" href="mmc2_8h.html#a7fa85cbe61c04a9f71c57aaf1c04cfcc">SDHC_flag</a> == 1) <a class="code" href="mmc2_8h.html#add9f7153567b2f38191b157d2caf7b79">cardType</a> = 2;
    <span class="keywordflow">else</span> <a class="code" href="mmc2_8h.html#add9f7153567b2f38191b157d2caf7b79">cardType</a> = 3;
  }
  
  <span class="comment">//SD_sendCommand(CRC_ON_OFF, OFF); //disable CRC; deafault - CRC disabled in SPI mode</span>
  <a class="code" href="mmc2_8c.html#a9faa6fa4ebcf98a07808f2d2c040dcfd">SD_sendCommand</a>(<a class="code" href="mmc2_8h.html#a2f0756e65bb52b5d7e7934ce1d5ec0da">SET_BLOCK_LEN</a>, 512); <span class="comment">//set block size to 512; default size is 512</span>
  
  
  <span class="keywordflow">return</span> 0; <span class="comment">//successful return</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a479d5a79e118601ffede156b20d87494"></a><!-- doxytag: member="mmc2.c::SD_readSingleBlock" ref="a479d5a79e118601ffede156b20d87494" args="(unsigned long startBlock)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned char SD_readSingleBlock </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>startBlock</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="mmc2_8c_source.html#l00220">220</a> of file <a class="el" href="mmc2_8c_source.html">mmc2.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> response;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, retry=0;
  
  response = <a class="code" href="mmc2_8c.html#a9faa6fa4ebcf98a07808f2d2c040dcfd">SD_sendCommand</a>(<a class="code" href="mmc2_8h.html#a078b4c06f187324dd4e14cf59a6c87c2">READ_SINGLE_BLOCK</a>, <a class="code" href="mmc2_8h.html#aef9ccbd37ff89101204c1ab239f94453">startBlock</a>); <span class="comment">//read a Block command</span>
  
  <span class="keywordflow">if</span>(response != 0x00) <span class="keywordflow">return</span> response; <span class="comment">//check for SD status: 0x00 - OK (No flags set)</span>
  
  <a class="code" href="mmc2_8h.html#ab42aba8ac59f4a88718f351bf6e30874">SD_CS_ASSERT</a>;
  
  retry = 0;
  <span class="keywordflow">while</span>(<a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xFF) != 0xfe) <span class="comment">//wait for start block token 0xfe (0x11111110)</span>
    <span class="keywordflow">if</span>(retry++ &gt; 0xfffe){<a class="code" href="mmc2_8h.html#ac13a5b7ed7d2ee96da07f2b2ae9249fe">SD_CS_DEASSERT</a>; <span class="keywordflow">return</span> 1;} <span class="comment">//return if time-out</span>
  
  <span class="keywordflow">for</span>(i=0; i&lt;512; i++) <span class="comment">//read 512 bytes</span>
    <a class="code" href="_main__mod3_8c.html#abbb739d03dfe3d5766f427e435af90aa">sd_buffer</a>[i] = <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xFF);
  
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xFF); <span class="comment">//receive incoming CRC (16-bit), CRC is ignored here</span>
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xFF);
  
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xFF); <span class="comment">//extra 8 clock pulses</span>
  <a class="code" href="mmc2_8h.html#ac13a5b7ed7d2ee96da07f2b2ae9249fe">SD_CS_DEASSERT</a>;
  
  <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a9faa6fa4ebcf98a07808f2d2c040dcfd"></a><!-- doxytag: member="mmc2.c::SD_sendCommand" ref="a9faa6fa4ebcf98a07808f2d2c040dcfd" args="(unsigned char cmd, unsigned long arg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned char SD_sendCommand </td>
          <td>(</td>
          <td class="paramtype">unsigned char&#160;</td>
          <td class="paramname"><em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>arg</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="mmc2_8c_source.html#l00136">136</a> of file <a class="el" href="mmc2_8c_source.html">mmc2.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> response, retry=0, status;
  
  <span class="comment">//SD card accepts byte address while SDHC accepts block address in multiples of 512</span>
  <span class="comment">//so, if it&#39;s SD card we need to convert block address into corresponding byte address by </span>
  <span class="comment">//multipying it with 512. which is equivalent to shifting it left 9 times</span>
  <span class="comment">//following &#39;if&#39; loop does that</span>
  
  <span class="keywordflow">if</span>(<a class="code" href="mmc2_8h.html#a7fa85cbe61c04a9f71c57aaf1c04cfcc">SDHC_flag</a> == 0)            
    <span class="keywordflow">if</span>(cmd == <a class="code" href="mmc2_8h.html#a078b4c06f187324dd4e14cf59a6c87c2">READ_SINGLE_BLOCK</a>     ||
       cmd == <a class="code" href="mmc2_8h.html#ac1b68c53e7902f7197cd9f52b163bda1">READ_MULTIPLE_BLOCKS</a>  ||
         cmd == <a class="code" href="mmc2_8h.html#ae24d09e65670aa853aa83889b55a92a0">WRITE_SINGLE_BLOCK</a>    ||
           cmd == <a class="code" href="mmc2_8h.html#a8cf5245e676d5405878f2af647491553">WRITE_MULTIPLE_BLOCKS</a> ||
             cmd == <a class="code" href="mmc2_8h.html#a0fe84e05b768d0f4b0f98a7f48a19f7f">ERASE_BLOCK_START_ADDR</a>|| 
               cmd == <a class="code" href="mmc2_8h.html#ade170f78d275c9bfd354e726e12435e2">ERASE_BLOCK_END_ADDR</a> ) 
    {
      arg = arg &lt;&lt; 9;
    }      
  
  <a class="code" href="mmc2_8h.html#ab42aba8ac59f4a88718f351bf6e30874">SD_CS_ASSERT</a>;
  
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(cmd | 0x40); <span class="comment">//send command, first two bits always &#39;01&#39;</span>
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(arg&gt;&gt;24);
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(arg&gt;&gt;16);
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(arg&gt;&gt;8);
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(arg);
  
  <span class="keywordflow">if</span>(cmd == <a class="code" href="mmc2_8h.html#a01bcf82717d75d8ccf0a8664d431738d">SEND_IF_COND</a>)        <span class="comment">//it is compulsory to send correct CRC for CMD8 (CRC=0x87) &amp; CMD0 (CRC=0x95)</span>
    <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0x87);    <span class="comment">//for remaining commands, CRC is ignored in SPI mode</span>
  <span class="keywordflow">else</span> 
    <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0x95); 
  
  <span class="keywordflow">while</span>((response = <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xFF)) == 0xff) <span class="comment">//wait response</span>
    <span class="keywordflow">if</span>(retry++ &gt; 0xfe) <span class="keywordflow">break</span>; <span class="comment">//time out error</span>
  
  <span class="keywordflow">if</span>(response == 0x00 &amp;&amp; cmd == 58)  <span class="comment">//checking response of CMD58</span>
  {
    status = <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xFF) &amp; 0x40;     <span class="comment">//first byte of the OCR register (bit 31:24)</span>
    <span class="keywordflow">if</span>(status == 0x40) <a class="code" href="mmc2_8h.html#a7fa85cbe61c04a9f71c57aaf1c04cfcc">SDHC_flag</a> = 1;  <span class="comment">//we need it to verify SDHC card</span>
    <span class="keywordflow">else</span> <a class="code" href="mmc2_8h.html#a7fa85cbe61c04a9f71c57aaf1c04cfcc">SDHC_flag</a> = 0;
    
    <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xFF); <span class="comment">//remaining 3 bytes of the OCR register are ignored here</span>
    <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xFF); <span class="comment">//one can use these bytes to check power supply limits of SD</span>
    <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xFF); 
  }
  
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xFF); <span class="comment">//extra 8 CLK</span>
  <a class="code" href="mmc2_8h.html#ac13a5b7ed7d2ee96da07f2b2ae9249fe">SD_CS_DEASSERT</a>;
  
  <span class="keywordflow">return</span> response; <span class="comment">//return state</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa72e78c5d2b4664dfdbb339030a1798c"></a><!-- doxytag: member="mmc2.c::SD_writeSingleBlock" ref="aa72e78c5d2b4664dfdbb339030a1798c" args="(unsigned long startBlock)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned char SD_writeSingleBlock </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>startBlock</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="mmc2_8c_source.html#l00253">253</a> of file <a class="el" href="mmc2_8c_source.html">mmc2.c</a>.</p>
<div class="fragment"><pre class="fragment">{
  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> response;
  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, retry=0;
  
  response = <a class="code" href="mmc2_8c.html#a9faa6fa4ebcf98a07808f2d2c040dcfd">SD_sendCommand</a>(<a class="code" href="mmc2_8h.html#ae24d09e65670aa853aa83889b55a92a0">WRITE_SINGLE_BLOCK</a>, <a class="code" href="mmc2_8h.html#aef9ccbd37ff89101204c1ab239f94453">startBlock</a>); <span class="comment">//write a Block command</span>
  
  <span class="keywordflow">if</span>(response != 0x00) <span class="keywordflow">return</span> response; <span class="comment">//check for SD status: 0x00 - OK (No flags set)</span>
  
  <a class="code" href="mmc2_8h.html#ab42aba8ac59f4a88718f351bf6e30874">SD_CS_ASSERT</a>;
  
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xfe);     <span class="comment">//Send start block token 0xfe (0x11111110)</span>
  
  <span class="keywordflow">for</span>(i=0; i&lt;512; i++)    <span class="comment">//send 512 bytes data</span>
    <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(<a class="code" href="_main__mod3_8c.html#abbb739d03dfe3d5766f427e435af90aa">sd_buffer</a>[i]);
  
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xff);     <span class="comment">//transmit dummy CRC (16-bit), CRC is ignored here</span>
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xff);
  
  response = <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xFF);
  
  <span class="keywordflow">if</span>( (response &amp; 0x1f) != 0x05) <span class="comment">//response= 0xXXX0AAA1 ; AAA=&#39;010&#39; - data accepted</span>
  {                              <span class="comment">//AAA=&#39;101&#39;-data rejected due to CRC error</span>
    <a class="code" href="mmc2_8h.html#ac13a5b7ed7d2ee96da07f2b2ae9249fe">SD_CS_DEASSERT</a>;              <span class="comment">//AAA=&#39;110&#39;-data rejected due to write error</span>
    <span class="keywordflow">return</span> response;
  }
  
  <span class="keywordflow">while</span>(!<a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xFF)) <span class="comment">//wait for SD card to complete writing and get idle</span>
    <span class="keywordflow">if</span>(retry++ &gt; 0xfffe){<a class="code" href="mmc2_8h.html#ac13a5b7ed7d2ee96da07f2b2ae9249fe">SD_CS_DEASSERT</a>; <span class="keywordflow">return</span> 1;}
  
  <a class="code" href="mmc2_8h.html#ac13a5b7ed7d2ee96da07f2b2ae9249fe">SD_CS_DEASSERT</a>;
  <a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xff);   <span class="comment">//just spend 8 clock cycle delay before reasserting the CS line</span>
  <a class="code" href="mmc2_8h.html#ab42aba8ac59f4a88718f351bf6e30874">SD_CS_ASSERT</a>;         <span class="comment">//re-asserting the CS line to verify if card is still busy</span>
  
  <span class="keywordflow">while</span>(!<a class="code" href="hal___s_p_i_8c.html#aac2a10918390006f9b3eca36566e9f7d">SPI_transmit</a>(0xFF)) <span class="comment">//wait for SD card to complete writing and get idle</span>
    <span class="keywordflow">if</span>(retry++ &gt; 0xfffe){<a class="code" href="mmc2_8h.html#ac13a5b7ed7d2ee96da07f2b2ae9249fe">SD_CS_DEASSERT</a>; <span class="keywordflow">return</span> 1;}
  <a class="code" href="mmc2_8h.html#ac13a5b7ed7d2ee96da07f2b2ae9249fe">SD_CS_DEASSERT</a>;
  
  <span class="keywordflow">return</span> 0;
}
</pre></div>
</div>
</div>
</div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="mmc2_8c.html">mmc2.c</a>      </li>
      <li class="footer">Generated on Sat Apr 30 2011 08:30:26 for Embedded GarageBand by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
