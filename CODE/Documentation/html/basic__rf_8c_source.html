<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Embedded GarageBand: basic_rf.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Picture1.jpg"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Embedded GarageBand&#160;<span id="projectnumber">1.0</span></div>
   <div id="projectbrief">The project is aimed at developing an embedded Garage band that uses an 8051 microcontroller. The user can access the instruments via the touchscreen+graphics LCD or use the instruments that we have constructed. In this document we will cover the complete detail of the project including its construction, hardware design, software design and debugging.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('basic__rf_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">basic_rf.c</div>  </div>
</div>
<div class="contents">
<a href="basic__rf_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/***********************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">  Filename:     basic_rf.c</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">  Description:  Basic RF library</span>
<a name="l00005"></a>00005 <span class="comment">  </span>
<a name="l00006"></a>00006 <span class="comment">  Code leveraged from Texas Instruments, Inc.</span>
<a name="l00007"></a>00007 <span class="comment">        Modified by:    Niket Shah</span>
<a name="l00008"></a>00008 <span class="comment">                                        Maulik Kapuria</span>
<a name="l00009"></a>00009 <span class="comment">                                        Vishal Verma</span>
<a name="l00010"></a>00010 <span class="comment"></span>
<a name="l00011"></a>00011 <span class="comment">***********************************************************************************/</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="comment">/***********************************************************************************</span>
<a name="l00014"></a>00014 <span class="comment">* INCLUDES</span>
<a name="l00015"></a>00015 <span class="comment">*/</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="hal__int_8h.html">hal_int.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="hal__mcu_8h.html">hal_mcu.h</a>&quot;</span>            <span class="comment">// Using halMcuWaitUs()</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="util_8h.html">util.h</a>&quot;</span>               <span class="comment">// Using min()</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;string.h&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="hal__types_8h.html">hal_types.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="hal__defs_8h.html">hal_defs.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="hal__rf_8h.html">hal_rf.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="util_8h.html">util.h</a>&quot;</span>               <span class="comment">// Using min()</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;string.h&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="basic__rf_8h.html">basic_rf.h</a>&quot;</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">/***********************************************************************************</span>
<a name="l00029"></a>00029 <span class="comment">* CONSTANTS AND DEFINES</span>
<a name="l00030"></a>00030 <span class="comment">*/</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="comment">// Packet and packet part lengths</span>
<a name="l00033"></a><a class="code" href="basic__rf_8c.html#ad8b9cce8b5696df98a3d65fb656d340a">00033</a> <span class="preprocessor">#define PKT_LEN_MIC                         8</span>
<a name="l00034"></a><a class="code" href="basic__rf_8c.html#a71bb9cb9dbb31ccf5ace5de8bdf06c34">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define PKT_LEN_SEC                         PKT_LEN_UNSEC + PKT_LEN_MIC</span>
<a name="l00035"></a><a class="code" href="basic__rf_8c.html#ad061a5b2c034b9b894c9ba60493b2295">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define PKT_LEN_AUTH                        8</span>
<a name="l00036"></a><a class="code" href="basic__rf_8c.html#abadb6d6a2544471fd97c1eb6f3a78a53">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define PKT_LEN_ENCR                        24</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span>
<a name="l00038"></a>00038 <span class="comment">// Packet overhead ((frame control field, sequence number, PAN ID,</span>
<a name="l00039"></a>00039 <span class="comment">// destination and source) + (footer))</span>
<a name="l00040"></a>00040 <span class="comment">// Note that the length byte itself is not included included in the packet length</span>
<a name="l00041"></a><a class="code" href="basic__rf_8c.html#a03d796febb1dbfaf4ed66228bec06bdb">00041</a> <span class="preprocessor">#define BASIC_RF_PACKET_OVERHEAD_SIZE       ((2 + 1 + 2 + 2 + 2) + (2))</span>
<a name="l00042"></a><a class="code" href="basic__rf_8c.html#a1aaceba4b43df3d8b6e09d002859aff5">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_MAX_PAYLOAD_SIZE               (127 - BASIC_RF_PACKET_OVERHEAD_SIZE - \</span>
<a name="l00043"></a>00043 <span class="preprocessor">    BASIC_RF_AUX_HDR_LENGTH - BASIC_RF_LEN_MIC)</span>
<a name="l00044"></a><a class="code" href="basic__rf_8c.html#a917845e1b4b471a67b07a2acf9620026">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_ACK_PACKET_SIZE                5</span>
<a name="l00045"></a><a class="code" href="basic__rf_8c.html#a070670ea1c677539ef054b92b8559cee">00045</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_FOOTER_SIZE                2</span>
<a name="l00046"></a><a class="code" href="basic__rf_8c.html#a93de3fb6eaf0e00f633fc1c802a63d1e">00046</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_HDR_SIZE                   10</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span>
<a name="l00048"></a>00048 <span class="comment">// The time it takes for the acknowledgment packet to be received after the</span>
<a name="l00049"></a>00049 <span class="comment">// data packet has been transmitted.</span>
<a name="l00050"></a><a class="code" href="basic__rf_8c.html#a00dc3203411cce0fc54f4e339e2cfdef">00050</a> <span class="preprocessor">#define BASIC_RF_ACK_DURATION                   (0.5 * 32 * 2 * ((4 + 1) + (1) + (2 + 1) + (2)))</span>
<a name="l00051"></a><a class="code" href="basic__rf_8c.html#af6c812a67a14425b9307263ff91f9343">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_SYMBOL_DURATION                (32 * 0.5)</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>
<a name="l00053"></a>00053 <span class="comment">// The length byte</span>
<a name="l00054"></a><a class="code" href="basic__rf_8c.html#a67573d3115cf1b16df66f9d15597c09f">00054</a> <span class="preprocessor">#define BASIC_RF_PLD_LEN_MASK               0x7F</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>
<a name="l00056"></a>00056 <span class="comment">// Frame control field</span>
<a name="l00057"></a><a class="code" href="basic__rf_8c.html#a6ea2ba00a82bbe9446d78e60b5877a85">00057</a> <span class="preprocessor">#define BASIC_RF_FCF_NOACK                  0x8841</span>
<a name="l00058"></a><a class="code" href="basic__rf_8c.html#a73fdc6f2d5b73abfa45fb03a847269e8">00058</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_FCF_ACK                    0x8861</span>
<a name="l00059"></a><a class="code" href="basic__rf_8c.html#acab5cb317f2f95dc91cd5b317277af7e">00059</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_FCF_ACK_BM                 0x0020</span>
<a name="l00060"></a><a class="code" href="basic__rf_8c.html#a7b4a3705bb712e7358cf6e62db69e4c2">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_FCF_BM                     (~BASIC_RF_FCF_ACK_BM)</span>
<a name="l00061"></a><a class="code" href="basic__rf_8c.html#a774a5fe4703f2b9f0f569b4917561ee8">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_SEC_ENABLED_FCF_BM         0x0008</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span>
<a name="l00063"></a>00063 <span class="comment">// Frame control field LSB</span>
<a name="l00064"></a><a class="code" href="basic__rf_8c.html#af2096cac191097e690cd9e4172affe85">00064</a> <span class="preprocessor">#define BASIC_RF_FCF_NOACK_L                LO_UINT16(BASIC_RF_FCF_NOACK)</span>
<a name="l00065"></a><a class="code" href="basic__rf_8c.html#a0504b1e638a25e50087c2b8883eb04ac">00065</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_FCF_ACK_L                  LO_UINT16(BASIC_RF_FCF_ACK)</span>
<a name="l00066"></a><a class="code" href="basic__rf_8c.html#aa3ba9656d5d70f95c3680b006cfd1c12">00066</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_FCF_ACK_BM_L               LO_UINT16(BASIC_RF_FCF_ACK_BM)</span>
<a name="l00067"></a><a class="code" href="basic__rf_8c.html#a9729e98c6ca2155eb4a86e6be796e07f">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_FCF_BM_L                   LO_UINT16(BASIC_RF_FCF_BM)</span>
<a name="l00068"></a><a class="code" href="basic__rf_8c.html#a32c71a0e33d991ac9c88caa13e2e3182">00068</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_SEC_ENABLED_FCF_BM_L       LO_UINT16(BASIC_RF_SEC_ENABLED_FCF_BM)</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>
<a name="l00070"></a>00070 <span class="comment">// Auxiliary Security header</span>
<a name="l00071"></a><a class="code" href="basic__rf_8c.html#ab8bad2e9b755d4a637e5f9be9b8d335f">00071</a> <span class="preprocessor">#define BASIC_RF_AUX_HDR_LENGTH             5</span>
<a name="l00072"></a><a class="code" href="basic__rf_8c.html#a953ad92953ad4cbc16bf46d26f6aebf6">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_LEN_AUTH                   BASIC_RF_PACKET_OVERHEAD_SIZE + \</span>
<a name="l00073"></a>00073 <span class="preprocessor">    BASIC_RF_AUX_HDR_LENGTH - BASIC_RF_FOOTER_SIZE</span>
<a name="l00074"></a><a class="code" href="basic__rf_8c.html#a3f9317fb3b47f4a775adbb543ca299d4">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_SECURITY_M                 2</span>
<a name="l00075"></a><a class="code" href="basic__rf_8c.html#a9263ce5a370dcb9b2a20dfdd53a08c6c">00075</a> <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_LEN_MIC                    8</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">#ifdef SECURITY_CCM</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="preprocessor">#undef BASIC_RF_HDR_SIZE</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">#define BASIC_RF_HDR_SIZE                   15</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00081"></a>00081 <span class="comment">// Footer</span>
<a name="l00082"></a><a class="code" href="basic__rf_8c.html#a2f7ff81ecb98a711b00ecf05062de467">00082</a> <span class="preprocessor">#define BASIC_RF_CRC_OK_BM                  0x80</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span>
<a name="l00084"></a>00084 <span class="comment">/***********************************************************************************</span>
<a name="l00085"></a>00085 <span class="comment">* TYPEDEFS</span>
<a name="l00086"></a>00086 <span class="comment">*/</span>
<a name="l00087"></a>00087 <span class="comment">// The receive struct</span>
<a name="l00088"></a><a class="code" href="structbasic_rf_rx_info__t.html">00088</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00089"></a><a class="code" href="structbasic_rf_rx_info__t.html#aa5eb7ede96f7f00da24e7b6d4ebe1d0a">00089</a>     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="structbasic_rf_rx_info__t.html#aa5eb7ede96f7f00da24e7b6d4ebe1d0a">seqNumber</a>;
<a name="l00090"></a><a class="code" href="structbasic_rf_rx_info__t.html#a7cb2225fb2b4dfc645c5c234e609c0e4">00090</a>     <a class="code" href="hal__types_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="structbasic_rf_rx_info__t.html#a7cb2225fb2b4dfc645c5c234e609c0e4">srcAddr</a>;
<a name="l00091"></a><a class="code" href="structbasic_rf_rx_info__t.html#a2ac3ff3aa5255df800d495bf23a131b6">00091</a>     <a class="code" href="hal__types_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> <a class="code" href="structbasic_rf_rx_info__t.html#a2ac3ff3aa5255df800d495bf23a131b6">srcPanId</a>;
<a name="l00092"></a><a class="code" href="structbasic_rf_rx_info__t.html#af9266e50356dd007e0b3989e17df1a82">00092</a>     <a class="code" href="hal__types_8h.html#a1b956fe1df85f3c132b21edb4e116458">int8</a> <a class="code" href="structbasic_rf_rx_info__t.html#af9266e50356dd007e0b3989e17df1a82">length</a>;
<a name="l00093"></a><a class="code" href="structbasic_rf_rx_info__t.html#a9461585da66b9bb6d3f2e950b2c6f4dd">00093</a>     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>* <a class="code" href="structbasic_rf_rx_info__t.html#a9461585da66b9bb6d3f2e950b2c6f4dd">pPayload</a>;
<a name="l00094"></a><a class="code" href="structbasic_rf_rx_info__t.html#a96f75c864979021cdf81ce2085821799">00094</a>     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="structbasic_rf_rx_info__t.html#a96f75c864979021cdf81ce2085821799">ackRequest</a>;
<a name="l00095"></a><a class="code" href="structbasic_rf_rx_info__t.html#a5a7f445193f8084cf2eb048f36c29d1c">00095</a>     <a class="code" href="hal__types_8h.html#a1b956fe1df85f3c132b21edb4e116458">int8</a> <a class="code" href="structbasic_rf_rx_info__t.html#a5a7f445193f8084cf2eb048f36c29d1c">rssi</a>;
<a name="l00096"></a><a class="code" href="structbasic_rf_rx_info__t.html#a2f4d0721248f73e49bc9e32362b6dcb1">00096</a>     <span class="keyword">volatile</span> <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="structbasic_rf_rx_info__t.html#a2f4d0721248f73e49bc9e32362b6dcb1">isReady</a>;
<a name="l00097"></a><a class="code" href="structbasic_rf_rx_info__t.html#a72422b4ffd3c9c466dff6959b3e16885">00097</a>     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="structbasic_rf_rx_info__t.html#a72422b4ffd3c9c466dff6959b3e16885">status</a>;
<a name="l00098"></a>00098 } <a class="code" href="structbasic_rf_rx_info__t.html">basicRfRxInfo_t</a>;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 <span class="comment">// Tx state</span>
<a name="l00101"></a><a class="code" href="structbasic_rf_tx_state__t.html">00101</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00102"></a><a class="code" href="structbasic_rf_tx_state__t.html#afeacb6ece372c19b18198fda274b3bdb">00102</a>     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="structbasic_rf_tx_state__t.html#afeacb6ece372c19b18198fda274b3bdb">txSeqNumber</a>;
<a name="l00103"></a><a class="code" href="structbasic_rf_tx_state__t.html#a83c76da0b55029bcffb2f2f9db9976a0">00103</a>     <span class="keyword">volatile</span> <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="structbasic_rf_tx_state__t.html#a83c76da0b55029bcffb2f2f9db9976a0">ackReceived</a>;
<a name="l00104"></a><a class="code" href="structbasic_rf_tx_state__t.html#ae9ea1758c5ff0649f4dacecbc6526ded">00104</a>     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="structbasic_rf_tx_state__t.html#ae9ea1758c5ff0649f4dacecbc6526ded">receiveOn</a>;
<a name="l00105"></a><a class="code" href="structbasic_rf_tx_state__t.html#aaa2d41a209294093ad7c03b13c71df50">00105</a>     <a class="code" href="hal__types_8h.html#a4b435a49c74bb91f284f075e63416cb6">uint32</a> <a class="code" href="structbasic_rf_tx_state__t.html#aaa2d41a209294093ad7c03b13c71df50">frameCounter</a>;
<a name="l00106"></a>00106 } <a class="code" href="structbasic_rf_tx_state__t.html">basicRfTxState_t</a>;
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 <span class="comment">// Basic RF packet header (IEEE 802.15.4)</span>
<a name="l00110"></a><a class="code" href="structbasic_rf_pkt_hdr__t.html">00110</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00111"></a><a class="code" href="structbasic_rf_pkt_hdr__t.html#a26b8a73b347a2110cfb1bab0bef83f69">00111</a>     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>   <a class="code" href="structbasic_rf_pkt_hdr__t.html#a26b8a73b347a2110cfb1bab0bef83f69">packetLength</a>;
<a name="l00112"></a><a class="code" href="structbasic_rf_pkt_hdr__t.html#a7876c1730d2584da13b6ab4f71a00f1c">00112</a>     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>   <a class="code" href="structbasic_rf_pkt_hdr__t.html#a7876c1730d2584da13b6ab4f71a00f1c">fcf0</a>;           <span class="comment">// Frame control field LSB</span>
<a name="l00113"></a><a class="code" href="structbasic_rf_pkt_hdr__t.html#abab1c726e43546c3d12ae520e0953c66">00113</a>     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>   <a class="code" href="structbasic_rf_pkt_hdr__t.html#abab1c726e43546c3d12ae520e0953c66">fcf1</a>;           <span class="comment">// Frame control field MSB</span>
<a name="l00114"></a><a class="code" href="structbasic_rf_pkt_hdr__t.html#aaffb480584827f92ee83bf5d3146392f">00114</a>     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>   <a class="code" href="structbasic_rf_pkt_hdr__t.html#aaffb480584827f92ee83bf5d3146392f">seqNumber</a>;
<a name="l00115"></a><a class="code" href="structbasic_rf_pkt_hdr__t.html#ac914da221dbe703a3a96204563232a7a">00115</a>     <a class="code" href="hal__types_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a>  <a class="code" href="structbasic_rf_pkt_hdr__t.html#ac914da221dbe703a3a96204563232a7a">panId</a>;
<a name="l00116"></a><a class="code" href="structbasic_rf_pkt_hdr__t.html#a82242467b7399cf53fcc80f73e7e09a3">00116</a>     <a class="code" href="hal__types_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a>  <a class="code" href="structbasic_rf_pkt_hdr__t.html#a82242467b7399cf53fcc80f73e7e09a3">destAddr</a>;
<a name="l00117"></a><a class="code" href="structbasic_rf_pkt_hdr__t.html#a6eaff5d52b1bd0bca9050d9ce0b18144">00117</a>     <a class="code" href="hal__types_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a>  <a class="code" href="structbasic_rf_pkt_hdr__t.html#a6eaff5d52b1bd0bca9050d9ce0b18144">srcAddr</a>;
<a name="l00118"></a>00118 <span class="preprocessor">    #ifdef SECURITY_CCM</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span>    <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>   securityControl;
<a name="l00120"></a>00120     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>  frameCounter[4];
<a name="l00121"></a>00121 <span class="preprocessor">    #endif</span>
<a name="l00122"></a>00122 <span class="preprocessor"></span>} <a class="code" href="structbasic_rf_pkt_hdr__t.html">basicRfPktHdr_t</a>;
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 <span class="comment">/***********************************************************************************</span>
<a name="l00126"></a>00126 <span class="comment">* LOCAL VARIABLES</span>
<a name="l00127"></a>00127 <span class="comment">*/</span>
<a name="l00128"></a><a class="code" href="basic__rf_8c.html#a5c331f61a00367c2d911e2dc071d829c">00128</a> <span class="keyword">static</span> <a class="code" href="structbasic_rf_rx_info__t.html">basicRfRxInfo_t</a>  <a class="code" href="basic__rf_8c.html#a5c331f61a00367c2d911e2dc071d829c">rxi</a>=      { 0xFF }; <span class="comment">// Make sure sequence numbers are</span>
<a name="l00129"></a><a class="code" href="basic__rf_8c.html#a30f0e1237418cb399715ec882124f36f">00129</a> <span class="keyword">static</span> <a class="code" href="structbasic_rf_tx_state__t.html">basicRfTxState_t</a> <a class="code" href="basic__rf_8c.html#a30f0e1237418cb399715ec882124f36f">txState</a>=  { 0x00 }; <span class="comment">// initialised and distinct.</span>
<a name="l00130"></a>00130 
<a name="l00131"></a><a class="code" href="basic__rf_8c.html#a62df39fc3dc7e7489bb77ff389ab84ad">00131</a> <span class="keyword">static</span> <a class="code" href="structbasic_rf_cfg__t.html">basicRfCfg_t</a>* <a class="code" href="basic__rf_8c.html#a62df39fc3dc7e7489bb77ff389ab84ad">pConfig</a>;
<a name="l00132"></a><a class="code" href="basic__rf_8c.html#a26238c725dbf1e4cd33796ce86d29b7f">00132</a> <span class="keyword">static</span> <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="basic__rf_8c.html#a26238c725dbf1e4cd33796ce86d29b7f">txMpdu</a>[<a class="code" href="basic__rf_8c.html#a1aaceba4b43df3d8b6e09d002859aff5">BASIC_RF_MAX_PAYLOAD_SIZE</a>+<a class="code" href="basic__rf_8c.html#a03d796febb1dbfaf4ed66228bec06bdb">BASIC_RF_PACKET_OVERHEAD_SIZE</a>+1];
<a name="l00133"></a><a class="code" href="basic__rf_8c.html#aaf2e9226ca3594d47cab724ba1d04a6b">00133</a> <span class="keyword">static</span> <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="basic__rf_8c.html#aaf2e9226ca3594d47cab724ba1d04a6b">rxMpdu</a>[128];
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="comment">/***********************************************************************************</span>
<a name="l00136"></a>00136 <span class="comment">* GLOBAL VARIABLES</span>
<a name="l00137"></a>00137 <span class="comment">*/</span>
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 <span class="comment">/***********************************************************************************</span>
<a name="l00141"></a>00141 <span class="comment">* LOCAL FUNCTIONS</span>
<a name="l00142"></a>00142 <span class="comment">*/</span>
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="comment">/***********************************************************************************</span>
<a name="l00146"></a>00146 <span class="comment">* @fn          basicRfBuildHeader</span>
<a name="l00147"></a>00147 <span class="comment">*</span>
<a name="l00148"></a>00148 <span class="comment">* @brief       Builds packet header according to IEEE 802.15.4 frame format</span>
<a name="l00149"></a>00149 <span class="comment">*</span>
<a name="l00150"></a>00150 <span class="comment">* @param       buffer - Pointer to buffer to write the header</span>
<a name="l00151"></a>00151 <span class="comment">*              destAddr - destination short address</span>
<a name="l00152"></a>00152 <span class="comment">*              payloadLength - length of higher layer payload</span>
<a name="l00153"></a>00153 <span class="comment">*</span>
<a name="l00154"></a>00154 <span class="comment">* @return      uint8 - length of header</span>
<a name="l00155"></a>00155 <span class="comment">*/</span>
<a name="l00156"></a><a class="code" href="basic__rf_8c.html#a40ba57f496a28fff78f3967dcc5ca35c">00156</a> <span class="keyword">static</span> <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="basic__rf_8c.html#a40ba57f496a28fff78f3967dcc5ca35c">basicRfBuildHeader</a>(<a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>* buffer, <a class="code" href="hal__types_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> destAddr, <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> payloadLength)
<a name="l00157"></a>00157 {
<a name="l00158"></a>00158     <a class="code" href="structbasic_rf_pkt_hdr__t.html">basicRfPktHdr_t</a> *pHdr;
<a name="l00159"></a>00159     <a class="code" href="hal__types_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> fcf;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     pHdr= (<a class="code" href="structbasic_rf_pkt_hdr__t.html">basicRfPktHdr_t</a>*)buffer;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <span class="comment">// Populate packet header</span>
<a name="l00164"></a>00164     pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a26b8a73b347a2110cfb1bab0bef83f69">packetLength</a> = payloadLength + <a class="code" href="basic__rf_8c.html#a03d796febb1dbfaf4ed66228bec06bdb">BASIC_RF_PACKET_OVERHEAD_SIZE</a>;
<a name="l00165"></a>00165     <span class="comment">//pHdr-&gt;frameControlField = pConfig-&gt;ackRequest ? BASIC_RF_FCF_ACK : BASIC_RF_FCF_NOACK;</span>
<a name="l00166"></a>00166     fcf= pConfig-&gt;<a class="code" href="structbasic_rf_cfg__t.html#a503a69424eb7f5eec08ac5289d5f4159">ackRequest</a> ? <a class="code" href="basic__rf_8c.html#a73fdc6f2d5b73abfa45fb03a847269e8">BASIC_RF_FCF_ACK</a> : <a class="code" href="basic__rf_8c.html#a6ea2ba00a82bbe9446d78e60b5877a85">BASIC_RF_FCF_NOACK</a>;
<a name="l00167"></a>00167     pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a7876c1730d2584da13b6ab4f71a00f1c">fcf0</a> = <a class="code" href="hal__defs_8h.html#ab2b94e11f455d94fd743666d4f1364d7">LO_UINT16</a>(fcf);
<a name="l00168"></a>00168     pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#abab1c726e43546c3d12ae520e0953c66">fcf1</a> = <a class="code" href="hal__defs_8h.html#a869398c9f0eb7bcf1c8e101b052eed07">HI_UINT16</a>(fcf);
<a name="l00169"></a>00169     pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#aaffb480584827f92ee83bf5d3146392f">seqNumber</a>= txState.<a class="code" href="structbasic_rf_tx_state__t.html#afeacb6ece372c19b18198fda274b3bdb">txSeqNumber</a>;
<a name="l00170"></a>00170     pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#ac914da221dbe703a3a96204563232a7a">panId</a>= pConfig-&gt;<a class="code" href="structbasic_rf_cfg__t.html#a198440aa336d6c82fb0341e47d6b5184">panId</a>;
<a name="l00171"></a>00171     pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a82242467b7399cf53fcc80f73e7e09a3">destAddr</a>= destAddr;
<a name="l00172"></a>00172     pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a6eaff5d52b1bd0bca9050d9ce0b18144">srcAddr</a>= pConfig-&gt;<a class="code" href="structbasic_rf_cfg__t.html#ae0435b4dbf855970610280ec1697239d">myAddr</a>;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174 <span class="preprocessor">    #ifdef SECURITY_CCM</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span>
<a name="l00176"></a>00176     <span class="comment">// Add security to FCF, length and security header</span>
<a name="l00177"></a>00177     pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a7876c1730d2584da13b6ab4f71a00f1c">fcf0</a> |= <a class="code" href="basic__rf_8c.html#a32c71a0e33d991ac9c88caa13e2e3182">BASIC_RF_SEC_ENABLED_FCF_BM_L</a>;
<a name="l00178"></a>00178     pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a26b8a73b347a2110cfb1bab0bef83f69">packetLength</a> += <a class="code" href="basic__rf_8c.html#ad8b9cce8b5696df98a3d65fb656d340a">PKT_LEN_MIC</a>;
<a name="l00179"></a>00179     pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a26b8a73b347a2110cfb1bab0bef83f69">packetLength</a> += <a class="code" href="basic__rf_8c.html#ab8bad2e9b755d4a637e5f9be9b8d335f">BASIC_RF_AUX_HDR_LENGTH</a>;
<a name="l00180"></a>00180 
<a name="l00181"></a>00181     pHdr-&gt;securityControl= SECURITY_CONTROL;
<a name="l00182"></a>00182     pHdr-&gt;frameCounter[0]=   <a class="code" href="hal__defs_8h.html#ab2b94e11f455d94fd743666d4f1364d7">LO_UINT16</a>(<a class="code" href="hal__defs_8h.html#a5753ba8c264117a62ff58a420cbe868c">LO_UINT32</a>(txState.<a class="code" href="structbasic_rf_tx_state__t.html#aaa2d41a209294093ad7c03b13c71df50">frameCounter</a>));
<a name="l00183"></a>00183     pHdr-&gt;frameCounter[1]=   <a class="code" href="hal__defs_8h.html#a869398c9f0eb7bcf1c8e101b052eed07">HI_UINT16</a>(<a class="code" href="hal__defs_8h.html#a5753ba8c264117a62ff58a420cbe868c">LO_UINT32</a>(txState.<a class="code" href="structbasic_rf_tx_state__t.html#aaa2d41a209294093ad7c03b13c71df50">frameCounter</a>));
<a name="l00184"></a>00184     pHdr-&gt;frameCounter[2]=   <a class="code" href="hal__defs_8h.html#ab2b94e11f455d94fd743666d4f1364d7">LO_UINT16</a>(<a class="code" href="hal__defs_8h.html#a6c312808cdfde4f7b7c5c66dd0246c50">HI_UINT32</a>(txState.<a class="code" href="structbasic_rf_tx_state__t.html#aaa2d41a209294093ad7c03b13c71df50">frameCounter</a>));
<a name="l00185"></a>00185     pHdr-&gt;frameCounter[3]=   <a class="code" href="hal__defs_8h.html#a869398c9f0eb7bcf1c8e101b052eed07">HI_UINT16</a>(<a class="code" href="hal__defs_8h.html#a6c312808cdfde4f7b7c5c66dd0246c50">HI_UINT32</a>(txState.<a class="code" href="structbasic_rf_tx_state__t.html#aaa2d41a209294093ad7c03b13c71df50">frameCounter</a>));
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 <span class="preprocessor">    #endif</span>
<a name="l00188"></a>00188 <span class="preprocessor"></span>
<a name="l00189"></a>00189     <span class="comment">// Make sure bytefields are network byte order</span>
<a name="l00190"></a>00190     <a class="code" href="hal__defs_8h.html#a1ca08b45eb7a4e8ba78f10748afbd4f5">UINT16_HTON</a>(pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#ac914da221dbe703a3a96204563232a7a">panId</a>);
<a name="l00191"></a>00191     <a class="code" href="hal__defs_8h.html#a1ca08b45eb7a4e8ba78f10748afbd4f5">UINT16_HTON</a>(pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a82242467b7399cf53fcc80f73e7e09a3">destAddr</a>);
<a name="l00192"></a>00192     <a class="code" href="hal__defs_8h.html#a1ca08b45eb7a4e8ba78f10748afbd4f5">UINT16_HTON</a>(pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a6eaff5d52b1bd0bca9050d9ce0b18144">srcAddr</a>);
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     <span class="keywordflow">return</span> <a class="code" href="basic__rf_8c.html#a93de3fb6eaf0e00f633fc1c802a63d1e">BASIC_RF_HDR_SIZE</a>;
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 <span class="comment">/***********************************************************************************</span>
<a name="l00199"></a>00199 <span class="comment">* @fn          basicRfBuildMpdu</span>
<a name="l00200"></a>00200 <span class="comment">*</span>
<a name="l00201"></a>00201 <span class="comment">* @brief       Builds mpdu (MAC header + payload) according to IEEE 802.15.4</span>
<a name="l00202"></a>00202 <span class="comment">*              frame format</span>
<a name="l00203"></a>00203 <span class="comment">*</span>
<a name="l00204"></a>00204 <span class="comment">* @param       destAddr - Destination short address</span>
<a name="l00205"></a>00205 <span class="comment">*              pPayload - pointer to buffer with payload</span>
<a name="l00206"></a>00206 <span class="comment">*              payloadLength - length of payload buffer</span>
<a name="l00207"></a>00207 <span class="comment">*</span>
<a name="l00208"></a>00208 <span class="comment">* @return      uint8 - length of mpdu</span>
<a name="l00209"></a>00209 <span class="comment">*/</span>
<a name="l00210"></a><a class="code" href="basic__rf_8c.html#a989a51f7c51b3de2dceffd9796703b93">00210</a> <span class="keyword">static</span> <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="basic__rf_8c.html#a989a51f7c51b3de2dceffd9796703b93">basicRfBuildMpdu</a>(<a class="code" href="hal__types_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> destAddr, <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>* pPayload, <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> payloadLength)
<a name="l00211"></a>00211 {
<a name="l00212"></a>00212     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> hdrLength, n;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     hdrLength = <a class="code" href="basic__rf_8c.html#a40ba57f496a28fff78f3967dcc5ca35c">basicRfBuildHeader</a>(<a class="code" href="basic__rf_8c.html#a26238c725dbf1e4cd33796ce86d29b7f">txMpdu</a>, destAddr, payloadLength);
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keywordflow">for</span>(n=0;n&lt;payloadLength;n++)
<a name="l00217"></a>00217     {
<a name="l00218"></a>00218         <a class="code" href="basic__rf_8c.html#a26238c725dbf1e4cd33796ce86d29b7f">txMpdu</a>[hdrLength+n] = pPayload[n];
<a name="l00219"></a>00219     }
<a name="l00220"></a>00220     <span class="keywordflow">return</span> hdrLength + payloadLength; <span class="comment">// total mpdu length</span>
<a name="l00221"></a>00221 }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 <span class="comment">/***********************************************************************************</span>
<a name="l00225"></a>00225 <span class="comment">* @fn          basicRfRxFrmDoneIsr</span>
<a name="l00226"></a>00226 <span class="comment">*</span>
<a name="l00227"></a>00227 <span class="comment">* @brief       Interrupt service routine for received frame from radio</span>
<a name="l00228"></a>00228 <span class="comment">*              (either data or acknowlegdement)</span>
<a name="l00229"></a>00229 <span class="comment">*</span>
<a name="l00230"></a>00230 <span class="comment">* @param       rxi - file scope variable info extracted from the last incoming</span>
<a name="l00231"></a>00231 <span class="comment">*                    frame</span>
<a name="l00232"></a>00232 <span class="comment">*              txState - file scope variable that keeps tx state info</span>
<a name="l00233"></a>00233 <span class="comment">*</span>
<a name="l00234"></a>00234 <span class="comment">* @return      none</span>
<a name="l00235"></a>00235 <span class="comment">*/</span>
<a name="l00236"></a><a class="code" href="basic__rf_8c.html#aaf218f041e672fa284de7f68f1c0d822">00236</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="basic__rf_8c.html#aaf218f041e672fa284de7f68f1c0d822">basicRfRxFrmDoneIsr</a>(<span class="keywordtype">void</span>)
<a name="l00237"></a>00237 {
<a name="l00238"></a>00238     <a class="code" href="structbasic_rf_pkt_hdr__t.html">basicRfPktHdr_t</a> *pHdr;
<a name="l00239"></a>00239     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> *pStatusWord;
<a name="l00240"></a>00240 <span class="preprocessor">    #ifdef SECURITY_CCM</span>
<a name="l00241"></a>00241 <span class="preprocessor"></span>    <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> authStatus=0;
<a name="l00242"></a>00242 <span class="preprocessor">    #endif</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span>
<a name="l00244"></a>00244     <span class="comment">// Map header to packet buffer</span>
<a name="l00245"></a>00245     pHdr= (<a class="code" href="structbasic_rf_pkt_hdr__t.html">basicRfPktHdr_t</a>*)<a class="code" href="basic__rf_8c.html#aaf2e9226ca3594d47cab724ba1d04a6b">rxMpdu</a>;
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     <span class="comment">// Clear interrupt and disable new RX frame done interrupt</span>
<a name="l00248"></a>00248     <a class="code" href="hal__rf_8c.html#a0e9016638b26539914831b98db749967">halRfDisableRxInterrupt</a>();
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <span class="comment">// Enable all other interrupt sources (enables interrupt nesting)</span>
<a name="l00251"></a>00251     <a class="code" href="hal__int_8c.html#a28575a71a2221e58baa6c4d45251f500">halIntOn</a>();
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="comment">// Read payload length.</span>
<a name="l00254"></a>00254     <a class="code" href="hal__rf_8c.html#a1e4b35a07e3bb5a6875bed1c6878f8e8">halRfReadRxBuf</a>(&amp;pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a26b8a73b347a2110cfb1bab0bef83f69">packetLength</a>,1);
<a name="l00255"></a>00255     pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a26b8a73b347a2110cfb1bab0bef83f69">packetLength</a> &amp;= <a class="code" href="basic__rf_8c.html#a67573d3115cf1b16df66f9d15597c09f">BASIC_RF_PLD_LEN_MASK</a>; <span class="comment">// Ignore MSB</span>
<a name="l00256"></a>00256     
<a name="l00257"></a>00257     <span class="comment">// Is this an acknowledgment packet?</span>
<a name="l00258"></a>00258     <span class="comment">// Only ack packets may be 5 bytes in total.</span>
<a name="l00259"></a>00259     <span class="keywordflow">if</span> (pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a26b8a73b347a2110cfb1bab0bef83f69">packetLength</a> == <a class="code" href="basic__rf_8c.html#a917845e1b4b471a67b07a2acf9620026">BASIC_RF_ACK_PACKET_SIZE</a>) {
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         <span class="comment">// Read the packet</span>
<a name="l00262"></a>00262         <a class="code" href="hal__rf_8c.html#a1e4b35a07e3bb5a6875bed1c6878f8e8">halRfReadRxBuf</a>(&amp;<a class="code" href="basic__rf_8c.html#aaf2e9226ca3594d47cab724ba1d04a6b">rxMpdu</a>[1], pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a26b8a73b347a2110cfb1bab0bef83f69">packetLength</a>);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264         <span class="comment">// Make sure byte fields are changed from network to host byte order</span>
<a name="l00265"></a>00265         <a class="code" href="hal__defs_8h.html#a55c3504bfa289dd789f38553fd65e36e">UINT16_NTOH</a>(pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#ac914da221dbe703a3a96204563232a7a">panId</a>);
<a name="l00266"></a>00266         <a class="code" href="hal__defs_8h.html#a55c3504bfa289dd789f38553fd65e36e">UINT16_NTOH</a>(pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a82242467b7399cf53fcc80f73e7e09a3">destAddr</a>);
<a name="l00267"></a>00267         <a class="code" href="hal__defs_8h.html#a55c3504bfa289dd789f38553fd65e36e">UINT16_NTOH</a>(pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a6eaff5d52b1bd0bca9050d9ce0b18144">srcAddr</a>);
<a name="l00268"></a>00268 <span class="preprocessor">        #ifdef SECURITY_CCM</span>
<a name="l00269"></a>00269 <span class="preprocessor"></span>        <a class="code" href="hal__defs_8h.html#a18f0ea61865d6cda9985259b35121d5b">UINT32_NTOH</a>(pHdr-&gt;frameCounter);
<a name="l00270"></a>00270 <span class="preprocessor">        #endif</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span>
<a name="l00272"></a>00272         rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a96f75c864979021cdf81ce2085821799">ackRequest</a> = !!(pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a7876c1730d2584da13b6ab4f71a00f1c">fcf0</a> &amp; <a class="code" href="basic__rf_8c.html#aa3ba9656d5d70f95c3680b006cfd1c12">BASIC_RF_FCF_ACK_BM_L</a>);
<a name="l00273"></a>00273 
<a name="l00274"></a>00274         <span class="comment">// Read the status word and check for CRC OK</span>
<a name="l00275"></a>00275         pStatusWord= <a class="code" href="basic__rf_8c.html#aaf2e9226ca3594d47cab724ba1d04a6b">rxMpdu</a> + 4;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277         <span class="comment">// Indicate the successful ACK reception if CRC and sequence number OK</span>
<a name="l00278"></a>00278         <span class="keywordflow">if</span> ((pStatusWord[1] &amp; <a class="code" href="basic__rf_8c.html#a2f7ff81ecb98a711b00ecf05062de467">BASIC_RF_CRC_OK_BM</a>) &amp;&amp; (pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#aaffb480584827f92ee83bf5d3146392f">seqNumber</a> == txState.<a class="code" href="structbasic_rf_tx_state__t.html#afeacb6ece372c19b18198fda274b3bdb">txSeqNumber</a>)) {
<a name="l00279"></a>00279             txState.<a class="code" href="structbasic_rf_tx_state__t.html#a83c76da0b55029bcffb2f2f9db9976a0">ackReceived</a> = <a class="code" href="key__map_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00280"></a>00280         }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282         <span class="comment">// No, it is data</span>
<a name="l00283"></a>00283     } <span class="keywordflow">else</span> {
<a name="l00284"></a>00284 
<a name="l00285"></a>00285         <span class="comment">// It is assumed that the radio rejects packets with invalid length.</span>
<a name="l00286"></a>00286         <span class="comment">// Subtract the number of bytes in the frame overhead to get actual payload.</span>
<a name="l00287"></a>00287 
<a name="l00288"></a>00288         rxi.<a class="code" href="structbasic_rf_rx_info__t.html#af9266e50356dd007e0b3989e17df1a82">length</a> = pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a26b8a73b347a2110cfb1bab0bef83f69">packetLength</a> - <a class="code" href="basic__rf_8c.html#a03d796febb1dbfaf4ed66228bec06bdb">BASIC_RF_PACKET_OVERHEAD_SIZE</a>;
<a name="l00289"></a>00289 
<a name="l00290"></a>00290 <span class="preprocessor">        #ifdef SECURITY_CCM</span>
<a name="l00291"></a>00291 <span class="preprocessor"></span>        rxi.<a class="code" href="structbasic_rf_rx_info__t.html#af9266e50356dd007e0b3989e17df1a82">length</a> -= (<a class="code" href="basic__rf_8c.html#ab8bad2e9b755d4a637e5f9be9b8d335f">BASIC_RF_AUX_HDR_LENGTH</a> + <a class="code" href="basic__rf_8c.html#a9263ce5a370dcb9b2a20dfdd53a08c6c">BASIC_RF_LEN_MIC</a>);
<a name="l00292"></a>00292         authStatus = halRfReadRxBufSecure(&amp;<a class="code" href="basic__rf_8c.html#aaf2e9226ca3594d47cab724ba1d04a6b">rxMpdu</a>[1], pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a26b8a73b347a2110cfb1bab0bef83f69">packetLength</a>, rxi.<a class="code" href="structbasic_rf_rx_info__t.html#af9266e50356dd007e0b3989e17df1a82">length</a>,
<a name="l00293"></a>00293                                         <a class="code" href="basic__rf_8c.html#a953ad92953ad4cbc16bf46d26f6aebf6">BASIC_RF_LEN_AUTH</a>, <a class="code" href="basic__rf_8c.html#a3f9317fb3b47f4a775adbb543ca299d4">BASIC_RF_SECURITY_M</a>);
<a name="l00294"></a>00294 <span class="preprocessor">        #else</span>
<a name="l00295"></a>00295 <span class="preprocessor"></span>        <a class="code" href="hal__rf_8c.html#a1e4b35a07e3bb5a6875bed1c6878f8e8">halRfReadRxBuf</a>(&amp;<a class="code" href="basic__rf_8c.html#aaf2e9226ca3594d47cab724ba1d04a6b">rxMpdu</a>[1], pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a26b8a73b347a2110cfb1bab0bef83f69">packetLength</a>);
<a name="l00296"></a>00296 <span class="preprocessor">        #endif</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span>
<a name="l00298"></a>00298         <span class="comment">// Make sure byte fields are changed from network to host byte order</span>
<a name="l00299"></a>00299         <a class="code" href="hal__defs_8h.html#a55c3504bfa289dd789f38553fd65e36e">UINT16_NTOH</a>(pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#ac914da221dbe703a3a96204563232a7a">panId</a>);
<a name="l00300"></a>00300         <a class="code" href="hal__defs_8h.html#a55c3504bfa289dd789f38553fd65e36e">UINT16_NTOH</a>(pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a82242467b7399cf53fcc80f73e7e09a3">destAddr</a>);
<a name="l00301"></a>00301         <a class="code" href="hal__defs_8h.html#a55c3504bfa289dd789f38553fd65e36e">UINT16_NTOH</a>(pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a6eaff5d52b1bd0bca9050d9ce0b18144">srcAddr</a>);
<a name="l00302"></a>00302 <span class="preprocessor">        #ifdef SECURITY_CCM</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span>        <a class="code" href="hal__defs_8h.html#a18f0ea61865d6cda9985259b35121d5b">UINT32_NTOH</a>(pHdr-&gt;frameCounter);
<a name="l00304"></a>00304 <span class="preprocessor">        #endif</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span>
<a name="l00306"></a>00306         rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a96f75c864979021cdf81ce2085821799">ackRequest</a> = !!(pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a7876c1730d2584da13b6ab4f71a00f1c">fcf0</a> &amp; <a class="code" href="basic__rf_8c.html#aa3ba9656d5d70f95c3680b006cfd1c12">BASIC_RF_FCF_ACK_BM_L</a>);
<a name="l00307"></a>00307 
<a name="l00308"></a>00308         <span class="comment">// Read the source address</span>
<a name="l00309"></a>00309         rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a7cb2225fb2b4dfc645c5c234e609c0e4">srcAddr</a>= pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a6eaff5d52b1bd0bca9050d9ce0b18144">srcAddr</a>;
<a name="l00310"></a>00310 
<a name="l00311"></a>00311         <span class="comment">// Read the packet payload</span>
<a name="l00312"></a>00312         rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a9461585da66b9bb6d3f2e950b2c6f4dd">pPayload</a> = <a class="code" href="basic__rf_8c.html#aaf2e9226ca3594d47cab724ba1d04a6b">rxMpdu</a> + <a class="code" href="basic__rf_8c.html#a93de3fb6eaf0e00f633fc1c802a63d1e">BASIC_RF_HDR_SIZE</a>;
<a name="l00313"></a>00313 
<a name="l00314"></a>00314         <span class="comment">// Read the FCS to get the RSSI and CRC</span>
<a name="l00315"></a>00315         pStatusWord= rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a9461585da66b9bb6d3f2e950b2c6f4dd">pPayload</a>+rxi.<a class="code" href="structbasic_rf_rx_info__t.html#af9266e50356dd007e0b3989e17df1a82">length</a>;
<a name="l00316"></a>00316 <span class="preprocessor">        #ifdef SECURITY_CCM</span>
<a name="l00317"></a>00317 <span class="preprocessor"></span>        pStatusWord+= <a class="code" href="basic__rf_8c.html#a9263ce5a370dcb9b2a20dfdd53a08c6c">BASIC_RF_LEN_MIC</a>;
<a name="l00318"></a>00318 <span class="preprocessor">        #endif</span>
<a name="l00319"></a>00319 <span class="preprocessor"></span>        rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a5a7f445193f8084cf2eb048f36c29d1c">rssi</a> = pStatusWord[0];
<a name="l00320"></a>00320 
<a name="l00321"></a>00321         <span class="comment">// Notify the application about the received data packet if the CRC is OK</span>
<a name="l00322"></a>00322         <span class="comment">// Throw packet if the previous packet had the same sequence number</span>
<a name="l00323"></a>00323         <span class="keywordflow">if</span>( (pStatusWord[1] &amp; <a class="code" href="basic__rf_8c.html#a2f7ff81ecb98a711b00ecf05062de467">BASIC_RF_CRC_OK_BM</a>) &amp;&amp; (rxi.<a class="code" href="structbasic_rf_rx_info__t.html#aa5eb7ede96f7f00da24e7b6d4ebe1d0a">seqNumber</a> != pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#aaffb480584827f92ee83bf5d3146392f">seqNumber</a>) ) {
<a name="l00324"></a>00324             <span class="comment">// If security is used check also that authentication passed</span>
<a name="l00325"></a>00325 <span class="preprocessor">            #ifdef SECURITY_CCM</span>
<a name="l00326"></a>00326 <span class="preprocessor"></span>            <span class="keywordflow">if</span>( authStatus==<a class="code" href="hal__defs_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a> ) {
<a name="l00327"></a>00327                 <span class="keywordflow">if</span> ( (pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a7876c1730d2584da13b6ab4f71a00f1c">fcf0</a> &amp; <a class="code" href="basic__rf_8c.html#a9729e98c6ca2155eb4a86e6be796e07f">BASIC_RF_FCF_BM_L</a>) ==
<a name="l00328"></a>00328                     (<a class="code" href="basic__rf_8c.html#af2096cac191097e690cd9e4172affe85">BASIC_RF_FCF_NOACK_L</a> | <a class="code" href="basic__rf_8c.html#a32c71a0e33d991ac9c88caa13e2e3182">BASIC_RF_SEC_ENABLED_FCF_BM_L</a>)) {
<a name="l00329"></a>00329                         rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a2f4d0721248f73e49bc9e32362b6dcb1">isReady</a> = <a class="code" href="key__map_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00330"></a>00330                 }
<a name="l00331"></a>00331             }
<a name="l00332"></a>00332 <span class="preprocessor">            #else</span>
<a name="l00333"></a>00333 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( ((pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#a7876c1730d2584da13b6ab4f71a00f1c">fcf0</a> &amp; (<a class="code" href="basic__rf_8c.html#a9729e98c6ca2155eb4a86e6be796e07f">BASIC_RF_FCF_BM_L</a>)) == <a class="code" href="basic__rf_8c.html#af2096cac191097e690cd9e4172affe85">BASIC_RF_FCF_NOACK_L</a>) ) {
<a name="l00334"></a>00334                 rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a2f4d0721248f73e49bc9e32362b6dcb1">isReady</a> = <a class="code" href="key__map_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00335"></a>00335             }              
<a name="l00336"></a>00336 <span class="preprocessor">            #endif</span>
<a name="l00337"></a>00337 <span class="preprocessor"></span>        }
<a name="l00338"></a>00338         rxi.<a class="code" href="structbasic_rf_rx_info__t.html#aa5eb7ede96f7f00da24e7b6d4ebe1d0a">seqNumber</a> = pHdr-&gt;<a class="code" href="structbasic_rf_pkt_hdr__t.html#aaffb480584827f92ee83bf5d3146392f">seqNumber</a>;
<a name="l00339"></a>00339     }
<a name="l00340"></a>00340   
<a name="l00341"></a>00341     <span class="comment">// Enable RX frame done interrupt again</span>
<a name="l00342"></a>00342     <a class="code" href="hal__int_8c.html#afaf8d7757306b6aad9c527f1c51551ca">halIntOff</a>();
<a name="l00343"></a>00343     <a class="code" href="hal__rf_8c.html#a9bcdf2f2fbe6e04668d69adfcc0741ad">halRfEnableRxInterrupt</a>();
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346 
<a name="l00347"></a>00347 <span class="comment">/***********************************************************************************</span>
<a name="l00348"></a>00348 <span class="comment">* GLOBAL FUNCTIONS</span>
<a name="l00349"></a>00349 <span class="comment">*/</span>
<a name="l00350"></a>00350 
<a name="l00351"></a>00351 <span class="comment">/***********************************************************************************</span>
<a name="l00352"></a>00352 <span class="comment">* @fn          basicRfInit</span>
<a name="l00353"></a>00353 <span class="comment">*</span>
<a name="l00354"></a>00354 <span class="comment">* @brief       Initialise basic RF datastructures. Sets channel, short address and</span>
<a name="l00355"></a>00355 <span class="comment">*              PAN id in the chip and configures interrupt on packet reception</span>
<a name="l00356"></a>00356 <span class="comment">*</span>
<a name="l00357"></a>00357 <span class="comment">* @param       pRfConfig - pointer to BASIC_RF_CONFIG struct.</span>
<a name="l00358"></a>00358 <span class="comment">*                          This struct must be allocated by higher layer</span>
<a name="l00359"></a>00359 <span class="comment">*              txState - file scope variable that keeps tx state info</span>
<a name="l00360"></a>00360 <span class="comment">*              rxi - file scope variable info extracted from the last incoming</span>
<a name="l00361"></a>00361 <span class="comment">*                    frame</span>
<a name="l00362"></a>00362 <span class="comment">*</span>
<a name="l00363"></a>00363 <span class="comment">* @return      none</span>
<a name="l00364"></a>00364 <span class="comment">*/</span>
<a name="l00365"></a><a class="code" href="basic__rf_8h.html#ae2490e5735320b9688cab4c259287801">00365</a> <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="basic__rf_8c.html#ae2490e5735320b9688cab4c259287801">basicRfInit</a>(<a class="code" href="structbasic_rf_cfg__t.html">basicRfCfg_t</a>* pRfConfig)
<a name="l00366"></a>00366 {
<a name="l00367"></a>00367     <span class="keywordflow">if</span> (<a class="code" href="hal__rf_8c.html#a3a3c78717a30105882a011973c1ab54b">halRfInit</a>()==<a class="code" href="hal__defs_8h.html#a681680feae4df4182d532564c42fa1fc">FAILED</a>)
<a name="l00368"></a>00368         <span class="keywordflow">return</span> <a class="code" href="hal__defs_8h.html#a681680feae4df4182d532564c42fa1fc">FAILED</a>;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     <a class="code" href="hal__int_8c.html#afaf8d7757306b6aad9c527f1c51551ca">halIntOff</a>();
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="comment">// Set the protocol configuration</span>
<a name="l00373"></a>00373     pConfig = pRfConfig;
<a name="l00374"></a>00374     rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a9461585da66b9bb6d3f2e950b2c6f4dd">pPayload</a>   = <a class="code" href="hal__defs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376     txState.<a class="code" href="structbasic_rf_tx_state__t.html#ae9ea1758c5ff0649f4dacecbc6526ded">receiveOn</a> = <a class="code" href="key__map_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00377"></a>00377     txState.<a class="code" href="structbasic_rf_tx_state__t.html#aaa2d41a209294093ad7c03b13c71df50">frameCounter</a> = 0;
<a name="l00378"></a>00378 
<a name="l00379"></a>00379     <span class="comment">// Set channel</span>
<a name="l00380"></a>00380     <a class="code" href="hal__rf_8c.html#ae4b044c4167743fdbcd044ab7cb3688e">halRfSetChannel</a>(pConfig-&gt;<a class="code" href="structbasic_rf_cfg__t.html#a2230c500bdc43d6a102c30ef11d1393d">channel</a>);
<a name="l00381"></a>00381 
<a name="l00382"></a>00382     <span class="comment">// Write the short address and the PAN ID to the CC2520 RAM</span>
<a name="l00383"></a>00383     <a class="code" href="hal__rf_8c.html#a60f4374927f82223729323f43c306e39">halRfSetShortAddr</a>(pConfig-&gt;<a class="code" href="structbasic_rf_cfg__t.html#ae0435b4dbf855970610280ec1697239d">myAddr</a>);
<a name="l00384"></a>00384     <a class="code" href="hal__rf_8c.html#a7dd55b2adf6e1750715619f51e25f0f9">halRfSetPanId</a>(pConfig-&gt;<a class="code" href="structbasic_rf_cfg__t.html#a198440aa336d6c82fb0341e47d6b5184">panId</a>);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <span class="comment">// if security is enabled, write key and nonce</span>
<a name="l00387"></a>00387 <span class="preprocessor">    #ifdef SECURITY_CCM</span>
<a name="l00388"></a>00388 <span class="preprocessor"></span>    basicRfSecurityInit(pConfig);
<a name="l00389"></a>00389 <span class="preprocessor">    #endif</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span>
<a name="l00391"></a>00391     <span class="comment">// Set up receive interrupt (received data or acknowlegment)</span>
<a name="l00392"></a>00392     <a class="code" href="hal__rf_8c.html#afad1482a48a69980ae862f9d987c96fa">halRfRxInterruptConfig</a>(<a class="code" href="basic__rf_8c.html#aaf218f041e672fa284de7f68f1c0d822">basicRfRxFrmDoneIsr</a>);
<a name="l00393"></a>00393 
<a name="l00394"></a>00394     <a class="code" href="hal__int_8c.html#a28575a71a2221e58baa6c4d45251f500">halIntOn</a>();
<a name="l00395"></a>00395 
<a name="l00396"></a>00396     <span class="keywordflow">return</span> <a class="code" href="hal__defs_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l00397"></a>00397 }
<a name="l00398"></a>00398 
<a name="l00399"></a>00399 
<a name="l00400"></a>00400 <span class="comment">/***********************************************************************************</span>
<a name="l00401"></a>00401 <span class="comment">* @fn          basicRfSendPacket</span>
<a name="l00402"></a>00402 <span class="comment">*</span>
<a name="l00403"></a>00403 <span class="comment">* @brief       Send packet</span>
<a name="l00404"></a>00404 <span class="comment">*</span>
<a name="l00405"></a>00405 <span class="comment">* @param       destAddr - destination short address</span>
<a name="l00406"></a>00406 <span class="comment">*              pPayload - pointer to payload buffer. This buffer must be</span>
<a name="l00407"></a>00407 <span class="comment">*                         allocated by higher layer.</span>
<a name="l00408"></a>00408 <span class="comment">*              length - length of payload</span>
<a name="l00409"></a>00409 <span class="comment">*              txState - file scope variable that keeps tx state info</span>
<a name="l00410"></a>00410 <span class="comment">*              mpdu - file scope variable. Buffer for the frame to send</span>
<a name="l00411"></a>00411 <span class="comment">*</span>
<a name="l00412"></a>00412 <span class="comment">* @return      basicRFStatus_t - SUCCESS or FAILED</span>
<a name="l00413"></a>00413 <span class="comment">*/</span>
<a name="l00414"></a><a class="code" href="basic__rf_8h.html#aca5cf1dd9663ea55c8b77a0c315e7e95">00414</a> <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="basic__rf_8c.html#aca5cf1dd9663ea55c8b77a0c315e7e95">basicRfSendPacket</a>(<a class="code" href="hal__types_8h.html#a05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> destAddr, <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>* pPayload, <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> length)
<a name="l00415"></a>00415 {
<a name="l00416"></a>00416     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> mpduLength;
<a name="l00417"></a>00417     <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> status;
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     <span class="comment">// Turn on receiver if its not on</span>
<a name="l00420"></a>00420     <span class="keywordflow">if</span>(!txState.<a class="code" href="structbasic_rf_tx_state__t.html#ae9ea1758c5ff0649f4dacecbc6526ded">receiveOn</a>) {
<a name="l00421"></a>00421         <a class="code" href="hal__rf_8c.html#adb9b5c0c3f8c5d464a488929b75284c6">halRfReceiveOn</a>();
<a name="l00422"></a>00422     }
<a name="l00423"></a>00423 
<a name="l00424"></a>00424     <span class="comment">// Check packet length</span>
<a name="l00425"></a>00425     length = <a class="code" href="util_8c.html#a118ccf681a4104d11c88df783ec1d625">min</a>(length, <a class="code" href="basic__rf_8c.html#a1aaceba4b43df3d8b6e09d002859aff5">BASIC_RF_MAX_PAYLOAD_SIZE</a>);
<a name="l00426"></a>00426 
<a name="l00427"></a>00427     <span class="comment">// Wait until the transceiver is idle</span>
<a name="l00428"></a>00428     <a class="code" href="hal__rf_8c.html#ae8a0ea8b57301765996561e4b703f6e7">halRfWaitTransceiverReady</a>();
<a name="l00429"></a>00429 
<a name="l00430"></a>00430     <span class="comment">// Turn off RX frame done interrupt to avoid interference on the SPI interface</span>
<a name="l00431"></a>00431     <a class="code" href="hal__rf_8c.html#a0e9016638b26539914831b98db749967">halRfDisableRxInterrupt</a>();
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     mpduLength = <a class="code" href="basic__rf_8c.html#a989a51f7c51b3de2dceffd9796703b93">basicRfBuildMpdu</a>(destAddr, pPayload, length);
<a name="l00434"></a>00434 
<a name="l00435"></a>00435 <span class="preprocessor">    #ifdef SECURITY_CCM</span>
<a name="l00436"></a>00436 <span class="preprocessor"></span>    halRfWriteTxBufSecure(<a class="code" href="basic__rf_8c.html#a26238c725dbf1e4cd33796ce86d29b7f">txMpdu</a>, mpduLength, length, <a class="code" href="basic__rf_8c.html#a953ad92953ad4cbc16bf46d26f6aebf6">BASIC_RF_LEN_AUTH</a>, <a class="code" href="basic__rf_8c.html#a3f9317fb3b47f4a775adbb543ca299d4">BASIC_RF_SECURITY_M</a>);
<a name="l00437"></a>00437     txState.<a class="code" href="structbasic_rf_tx_state__t.html#aaa2d41a209294093ad7c03b13c71df50">frameCounter</a>++;     <span class="comment">// Increment frame counter field</span>
<a name="l00438"></a>00438 <span class="preprocessor">    #else</span>
<a name="l00439"></a>00439 <span class="preprocessor"></span>    <a class="code" href="hal__rf_8c.html#a4371f402044d251326d6288928b0bdd0">halRfWriteTxBuf</a>(<a class="code" href="basic__rf_8c.html#a26238c725dbf1e4cd33796ce86d29b7f">txMpdu</a>, mpduLength);
<a name="l00440"></a>00440 <span class="preprocessor">    #endif</span>
<a name="l00441"></a>00441 <span class="preprocessor"></span>
<a name="l00442"></a>00442     <span class="comment">// Turn on RX frame done interrupt for ACK reception</span>
<a name="l00443"></a>00443     <a class="code" href="hal__rf_8c.html#a9bcdf2f2fbe6e04668d69adfcc0741ad">halRfEnableRxInterrupt</a>();
<a name="l00444"></a>00444 
<a name="l00445"></a>00445     <span class="comment">// Send frame with CCA. return FAILED if not successful</span>
<a name="l00446"></a>00446     <span class="keywordflow">if</span>(<a class="code" href="hal__rf_8c.html#a58498e7b18acfedc38b011f95f2c1fa1">halRfTransmit</a>() != <a class="code" href="hal__defs_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>) {
<a name="l00447"></a>00447         status = <a class="code" href="hal__defs_8h.html#a681680feae4df4182d532564c42fa1fc">FAILED</a>;
<a name="l00448"></a>00448     }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450     <span class="comment">// Wait for the acknowledge to be received, if any</span>
<a name="l00451"></a>00451     <span class="keywordflow">if</span> (pConfig-&gt;<a class="code" href="structbasic_rf_cfg__t.html#a503a69424eb7f5eec08ac5289d5f4159">ackRequest</a>) {
<a name="l00452"></a>00452         txState.<a class="code" href="structbasic_rf_tx_state__t.html#a83c76da0b55029bcffb2f2f9db9976a0">ackReceived</a> = <a class="code" href="key__map_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00453"></a>00453 
<a name="l00454"></a>00454         <span class="comment">// We&#39;ll enter RX automatically, so just wait until we can be sure that the ack reception should have finished</span>
<a name="l00455"></a>00455         <span class="comment">// The timeout consists of a 12-symbol turnaround time, the ack packet duration, and a small margin</span>
<a name="l00456"></a>00456         <a class="code" href="hal__mcu_8c.html#ae4c291df9a657ba3f741e98ce96bd758">halMcuWaitUs</a>((12 * <a class="code" href="basic__rf_8c.html#af6c812a67a14425b9307263ff91f9343">BASIC_RF_SYMBOL_DURATION</a>) + (<a class="code" href="basic__rf_8c.html#a00dc3203411cce0fc54f4e339e2cfdef">BASIC_RF_ACK_DURATION</a>) + (2 * <a class="code" href="basic__rf_8c.html#af6c812a67a14425b9307263ff91f9343">BASIC_RF_SYMBOL_DURATION</a>) + 10);
<a name="l00457"></a>00457 
<a name="l00458"></a>00458         <span class="comment">// If an acknowledgment has been received (by RxFrmDoneIsr), the ackReceived flag should be set</span>
<a name="l00459"></a>00459         status = txState.<a class="code" href="structbasic_rf_tx_state__t.html#a83c76da0b55029bcffb2f2f9db9976a0">ackReceived</a> ? <a class="code" href="hal__defs_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a> : <a class="code" href="hal__defs_8h.html#a681680feae4df4182d532564c42fa1fc">FAILED</a>;
<a name="l00460"></a>00460 
<a name="l00461"></a>00461     } <span class="keywordflow">else</span> {
<a name="l00462"></a>00462         status = <a class="code" href="hal__defs_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l00463"></a>00463     }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465     <span class="comment">// Turn off the receiver if it should not continue to be enabled</span>
<a name="l00466"></a>00466     <span class="keywordflow">if</span> (!txState.<a class="code" href="structbasic_rf_tx_state__t.html#ae9ea1758c5ff0649f4dacecbc6526ded">receiveOn</a>) {
<a name="l00467"></a>00467         <a class="code" href="hal__rf_8c.html#ab2ebc515c36341d1b932d90b716e39d4">halRfReceiveOff</a>();
<a name="l00468"></a>00468     }
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     <span class="keywordflow">if</span>(status == <a class="code" href="hal__defs_8h.html#aa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>) {
<a name="l00471"></a>00471         txState.<a class="code" href="structbasic_rf_tx_state__t.html#afeacb6ece372c19b18198fda274b3bdb">txSeqNumber</a>++;
<a name="l00472"></a>00472     }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 <span class="preprocessor">#ifdef SECURITY_CCM</span>
<a name="l00475"></a>00475 <span class="preprocessor"></span>    halRfIncNonceTx();          <span class="comment">// Increment nonce value</span>
<a name="l00476"></a>00476 <span class="preprocessor">#endif</span>
<a name="l00477"></a>00477 <span class="preprocessor"></span>
<a name="l00478"></a>00478     <span class="keywordflow">return</span> status;
<a name="l00479"></a>00479 
<a name="l00480"></a>00480 }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 <span class="comment">/***********************************************************************************</span>
<a name="l00484"></a>00484 <span class="comment">* @fn          basicRfPacketIsReady</span>
<a name="l00485"></a>00485 <span class="comment">*</span>
<a name="l00486"></a>00486 <span class="comment">* @brief       Check if a new packet is ready to be read by next higher layer</span>
<a name="l00487"></a>00487 <span class="comment">*</span>
<a name="l00488"></a>00488 <span class="comment">* @param       none</span>
<a name="l00489"></a>00489 <span class="comment">*</span>
<a name="l00490"></a>00490 <span class="comment">* @return      uint8 - TRUE if a packet is ready to be read by higher layer</span>
<a name="l00491"></a>00491 <span class="comment">*/</span>
<a name="l00492"></a><a class="code" href="basic__rf_8h.html#a222c6dfbb12d4b67ce35257de2138d92">00492</a> <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="basic__rf_8c.html#a222c6dfbb12d4b67ce35257de2138d92">basicRfPacketIsReady</a>(<span class="keywordtype">void</span>)
<a name="l00493"></a>00493 {
<a name="l00494"></a>00494     <span class="keywordflow">return</span> rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a2f4d0721248f73e49bc9e32362b6dcb1">isReady</a>;
<a name="l00495"></a>00495 }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497 
<a name="l00498"></a>00498 <span class="comment">/**********************************************************************************</span>
<a name="l00499"></a>00499 <span class="comment">* @fn          basicRfReceive</span>
<a name="l00500"></a>00500 <span class="comment">*</span>
<a name="l00501"></a>00501 <span class="comment">* @brief       Copies the payload of the last incoming packet into a buffer</span>
<a name="l00502"></a>00502 <span class="comment">*</span>
<a name="l00503"></a>00503 <span class="comment">* @param       pRxData - pointer to data buffer to fill. This buffer must be</span>
<a name="l00504"></a>00504 <span class="comment">*                        allocated by higher layer.</span>
<a name="l00505"></a>00505 <span class="comment">*              len - Number of bytes to read in to buffer</span>
<a name="l00506"></a>00506 <span class="comment">*              rxi - file scope variable holding the information of the last</span>
<a name="l00507"></a>00507 <span class="comment">*                    incoming packet</span>
<a name="l00508"></a>00508 <span class="comment">*</span>
<a name="l00509"></a>00509 <span class="comment">* @return      uint8 - number of bytes actually copied into buffer</span>
<a name="l00510"></a>00510 <span class="comment">*/</span>
<a name="l00511"></a><a class="code" href="basic__rf_8h.html#af9fb2231fcee94f6996af72b5a9a80e7">00511</a> <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> <a class="code" href="basic__rf_8c.html#af9fb2231fcee94f6996af72b5a9a80e7">basicRfReceive</a>(<a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a>* pRxData, <a class="code" href="hal__types_8h.html#adde6aaee8457bee49c2a92621fe22b79">uint8</a> len, <a class="code" href="hal__types_8h.html#a259fa4834387bd68627ddf37bb3ebdb9">int16</a>* pRssi)
<a name="l00512"></a>00512 {
<a name="l00513"></a>00513     <span class="comment">// Accessing shared variables -&gt; this is a critical region</span>
<a name="l00514"></a>00514     <span class="comment">// Critical region start</span>
<a name="l00515"></a>00515     <a class="code" href="hal__int_8c.html#afaf8d7757306b6aad9c527f1c51551ca">halIntOff</a>();
<a name="l00516"></a>00516     memcpy(pRxData, rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a9461585da66b9bb6d3f2e950b2c6f4dd">pPayload</a>, <a class="code" href="util_8c.html#a118ccf681a4104d11c88df783ec1d625">min</a>(rxi.<a class="code" href="structbasic_rf_rx_info__t.html#af9266e50356dd007e0b3989e17df1a82">length</a>, len));
<a name="l00517"></a>00517     <span class="keywordflow">if</span>(pRssi != <a class="code" href="hal__defs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00518"></a>00518         <span class="keywordflow">if</span>(rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a5a7f445193f8084cf2eb048f36c29d1c">rssi</a> &lt; 128){
<a name="l00519"></a>00519             *pRssi = rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a5a7f445193f8084cf2eb048f36c29d1c">rssi</a> - <a class="code" href="hal__rf_8c.html#a4704f87be83afaa7487891a8527bf2c4">halRfGetRssiOffset</a>();
<a name="l00520"></a>00520         }
<a name="l00521"></a>00521         <span class="keywordflow">else</span>{
<a name="l00522"></a>00522             *pRssi = (rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a5a7f445193f8084cf2eb048f36c29d1c">rssi</a> - 256) - <a class="code" href="hal__rf_8c.html#a4704f87be83afaa7487891a8527bf2c4">halRfGetRssiOffset</a>();
<a name="l00523"></a>00523         }
<a name="l00524"></a>00524     }
<a name="l00525"></a>00525     rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a2f4d0721248f73e49bc9e32362b6dcb1">isReady</a> = <a class="code" href="key__map_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00526"></a>00526     <a class="code" href="hal__int_8c.html#a28575a71a2221e58baa6c4d45251f500">halIntOn</a>();
<a name="l00527"></a>00527 
<a name="l00528"></a>00528     <span class="comment">// Critical region end</span>
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     <span class="keywordflow">return</span> <a class="code" href="util_8c.html#a118ccf681a4104d11c88df783ec1d625">min</a>(rxi.<a class="code" href="structbasic_rf_rx_info__t.html#af9266e50356dd007e0b3989e17df1a82">length</a>, len);
<a name="l00531"></a>00531 }
<a name="l00532"></a>00532 
<a name="l00533"></a>00533 
<a name="l00534"></a>00534 <span class="comment">/**********************************************************************************</span>
<a name="l00535"></a>00535 <span class="comment">* @fn          basicRfGetRssi</span>
<a name="l00536"></a>00536 <span class="comment">*</span>
<a name="l00537"></a>00537 <span class="comment">* @brief       Copies the payload of the last incoming packet into a buffer</span>
<a name="l00538"></a>00538 <span class="comment">*</span>
<a name="l00539"></a>00539 <span class="comment">* @param       none</span>
<a name="l00540"></a>00540 <span class="comment"></span>
<a name="l00541"></a>00541 <span class="comment">* @return      int8 - RSSI value</span>
<a name="l00542"></a>00542 <span class="comment">*/</span>
<a name="l00543"></a><a class="code" href="basic__rf_8h.html#aa2412e5f3dd41253f37116354e856e2a">00543</a> <a class="code" href="hal__types_8h.html#a1b956fe1df85f3c132b21edb4e116458">int8</a> <a class="code" href="basic__rf_8c.html#aa2412e5f3dd41253f37116354e856e2a">basicRfGetRssi</a>(<span class="keywordtype">void</span>)
<a name="l00544"></a>00544 {
<a name="l00545"></a>00545     <span class="keywordflow">if</span>(rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a5a7f445193f8084cf2eb048f36c29d1c">rssi</a> &lt; 128){
<a name="l00546"></a>00546         <span class="keywordflow">return</span> rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a5a7f445193f8084cf2eb048f36c29d1c">rssi</a> - <a class="code" href="hal__rf_8c.html#a4704f87be83afaa7487891a8527bf2c4">halRfGetRssiOffset</a>();
<a name="l00547"></a>00547     }
<a name="l00548"></a>00548     <span class="keywordflow">else</span>{
<a name="l00549"></a>00549         <span class="keywordflow">return</span> (rxi.<a class="code" href="structbasic_rf_rx_info__t.html#a5a7f445193f8084cf2eb048f36c29d1c">rssi</a> - 256) - <a class="code" href="hal__rf_8c.html#a4704f87be83afaa7487891a8527bf2c4">halRfGetRssiOffset</a>();
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551 }
<a name="l00552"></a>00552 
<a name="l00553"></a>00553 <span class="comment">/***********************************************************************************</span>
<a name="l00554"></a>00554 <span class="comment">* @fn          basicRfReceiveOn</span>
<a name="l00555"></a>00555 <span class="comment">*</span>
<a name="l00556"></a>00556 <span class="comment">* @brief       Turns on receiver on radio</span>
<a name="l00557"></a>00557 <span class="comment">*</span>
<a name="l00558"></a>00558 <span class="comment">* @param       txState - file scope variable</span>
<a name="l00559"></a>00559 <span class="comment">*</span>
<a name="l00560"></a>00560 <span class="comment">* @return      none</span>
<a name="l00561"></a>00561 <span class="comment">*/</span>
<a name="l00562"></a><a class="code" href="basic__rf_8h.html#ae4911221feea8be8e36f8e497d3e0a87">00562</a> <span class="keywordtype">void</span> <a class="code" href="basic__rf_8c.html#ae4911221feea8be8e36f8e497d3e0a87">basicRfReceiveOn</a>(<span class="keywordtype">void</span>)
<a name="l00563"></a>00563 {
<a name="l00564"></a>00564     txState.<a class="code" href="structbasic_rf_tx_state__t.html#ae9ea1758c5ff0649f4dacecbc6526ded">receiveOn</a> = <a class="code" href="key__map_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00565"></a>00565     <a class="code" href="hal__rf_8c.html#adb9b5c0c3f8c5d464a488929b75284c6">halRfReceiveOn</a>();
<a name="l00566"></a>00566 }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568 
<a name="l00569"></a>00569 <span class="comment">/***********************************************************************************</span>
<a name="l00570"></a>00570 <span class="comment">* @fn          basicRfReceiveOff</span>
<a name="l00571"></a>00571 <span class="comment">*</span>
<a name="l00572"></a>00572 <span class="comment">* @brief       Turns off receiver on radio</span>
<a name="l00573"></a>00573 <span class="comment">*</span>
<a name="l00574"></a>00574 <span class="comment">* @param       txState - file scope variable</span>
<a name="l00575"></a>00575 <span class="comment">*</span>
<a name="l00576"></a>00576 <span class="comment">* @return      none</span>
<a name="l00577"></a>00577 <span class="comment">*/</span>
<a name="l00578"></a><a class="code" href="basic__rf_8h.html#afb44c177594fb28d443c35289e4a87df">00578</a> <span class="keywordtype">void</span> <a class="code" href="basic__rf_8c.html#afb44c177594fb28d443c35289e4a87df">basicRfReceiveOff</a>(<span class="keywordtype">void</span>)
<a name="l00579"></a>00579 {
<a name="l00580"></a>00580     txState.<a class="code" href="structbasic_rf_tx_state__t.html#ae9ea1758c5ff0649f4dacecbc6526ded">receiveOn</a> = <a class="code" href="key__map_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00581"></a>00581     <a class="code" href="hal__rf_8c.html#ab2ebc515c36341d1b932d90b716e39d4">halRfReceiveOff</a>();
<a name="l00582"></a>00582 }
<a name="l00583"></a>00583 
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="basic__rf_8c.html">basic_rf.c</a>      </li>
      <li class="footer">Generated on Sat Apr 30 2011 08:30:24 for Embedded GarageBand by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
